<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>TDD with Chef</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="../css/reveal.css">
		<link rel="stylesheet" href="../css/theme/black.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="../lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? '../css/print/pdf.css' : '../css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Slide-deck **************************************** -->

			<div class="slides">

				<section>
					<h1>TDD with Chef</h1>
					<h3 style="color:#888">Fun with <strike>flags</strike> testing</h3>
					<p>
						<small>Created by <a href="http://au.linkedin.com/in/simonesoldateschi" target="_blank">Simone Soldateschi</a> / <a href="http://twitter.com/soldasimo" target="_blank">@soldasimo</a></small>
					</p>
				</section>

				<section style="text-align: left;">
					<img src="images/siso.jpg" style="height: 400px; float:right; margin-top:150px;">
					<h1>Who am I?</h1>
					<a href="http://au.linkedin.com/in/simonesoldateschi" target="_blank">Simone Soldateschi</a> (<a href="http://twitter.com/soldasimo" target="_blank">@soldasimo</a>)
					<p>
						<small>
							- <b>Snr DevOps Engineer</b> based in Sydney<br />
							- Leading DevOps Engineering Team at Rackspace AU<br />
							- 15 years of experience as:<br />
							&nbsp;&nbsp;&nbsp;&nbsp;- SysAdmin<br />
							&nbsp;&nbsp;&nbsp;&nbsp;- SoftwareEng<br />
							&nbsp;&nbsp;&nbsp;&nbsp;- SysEng<br />
							- Been DevOps'in for the last 5-ish years<br />
						</small>
					</p>
				</section>

				<section>
					<section id="tdd-fragments">
						<h2>What is TDD?</h2>
						<p class="fragment">Test Driven Development</p>
						<p>
							<span class="fragment">Meaning...</span>
							<span class="fragment">write tests</span><br />
							<span class="fragment">see them fail</span><br />
							<span class="fragment">write code to pass tests</span><br />
							<span class="fragment">&nbsp;</span>
							<span class="fragment" style="color:#555"><i>...still waiting...</i></span>
						</p>
						<h2 class="fragment">Sounds weird? ;)</h2>
					</section>
				</section>

				<section data-background="images/morpheus_demo.jpg" data-background-size="1024px">
					<aside class="notes">
						This slide has fragments which are also stepped through in the notes window.
					</aside>
				</section>

				<section data-background="images/fractal_tree.svg">
					<section id="fractal-demo-fragments">
						<h2>Why?</h2>
						<p>
							<span class="fragment">no <i>PowerPoint-like</i> presentation</span><br />
							<span class="fragment">using the mouse is boring </span><br />
							&nbsp;&nbsp;&nbsp;&nbsp;<span class="fragment"><i>and I don't have one</i></span><br />
							<span class="fragment"><b>coding is fun</b></span><br />
							<span class="fragment">&nbsp;</span>
							<h2><span class="fragment">It's live-demo<span class="fragment">, with TDD!</h2>
						</p>
						<aside class="notes">
							Let me explain how this works:
							- Powerpoint-like presesentations are boring...
						</aside>
					</section>
				</section>

				<section data-background="images/fractal_tree.svg">
					<section id="fractal-demo-fragments-1">
						<h2>How?</h2>
						<p>
							<span class="fragment">Use TDD</span><br />
							<span class="fragment">Write Chef Cookbook</span><br />
							<span class="fragment">Deploy <i>node.js web-app</i></span><br />
							<span class="fragment">Leverage Vagrant</span><span class="fragment">, Docker</span><span class="fragment">, or Cloud Server</span><br />
							<span class="fragment">Run this very presentation</span><br />
							<span class="fragment">&nbsp;&nbsp;&nbsp;&nbsp;</span><br />
							<span class="fragment">Kinda <i>recursive</i>, isn't it? ;)</span><br />
						</p>
						<aside class="notes">
							So in the end this presewntation is about using TDD, to write code, which runs on any systems, to tell you how to run itself. Kinda <i>recursive</i>, isn't it! ;)
						</aside>
					</section>
				</section>

				<section>
					<h2>What do you use?</h2>
					<section>&nbsp;</section>
					<section data-background="images/Chef_Vertical_CCan_Reg.png" data-background-size="200px">
						<aside class="notes">
							Before we get started...

							- How many of you are learning Chef?
							- How many of you use Chef in production?
								- Chef Server, or Chef Manage?
						</aside>
					</section>
					<section data-background="images/ansiblelogo_transparent_web.png" data-background-size="200px">
						<aside class="notes">
							How many of you use Ansible?
						</aside>
					</section>
					<section data-background="images/puppet_logo_300.png" data-background-size="200px">
						<aside class="notes">
							- How many of you use Puppet?
							- Do you use any other tool?
						</aside>
					</section>
				</section>

				<section>
					<section id="coding-1-fragments">
						<h2>"The Usual" deploy workflow</h2>
						<p>
							<span class="fragment">start coding</span><br />
							<span class="fragment">compile it</span><br />
							<span class="fragment">deploy artifacts</span><br />
							<span class="fragment">looks good?</span><br />
							<span class="fragment">&nbsp;</span>
							<span class="fragment" style="color:#555"><i>wait</i></span>
							<span class="fragment">&nbsp;</span>
							<span class="fragment" style="color:#555"><i>...still waiting...</i></span>
							<span class="fragment">any issues?</span>
						</p>
						<h2 class="fragment">Reactive approach</h2>
						<aside class="notes">
							No assurance that features are implemented correctly is given.
							No test are run against artifacts.

							That leads to "firefighting"!
						</aside>
					</section>
				</section>

				<section data-background="images/Aircraft_Rescue_Firefighting_training.jpg">
					<!-- <h1>Fire-fighting</h1> -->
					<!-- <img src="images/Aircraft_Rescue_Firefighting_training.jpg" style="height: 500px; margin-top:0px; border:0px;" /> -->
					<!-- http://en.wikipedia.org/wiki/Firefighting#/media/File:Aircraft_Rescue_Firefighting_training.jpg -->
					<aside class="notes">
						Go live with without testing leads to "firefighting"!
					</aside>
				</section>

				<section>
					<h2>Chef Overview</h2>
					<section>
						&nbsp;
						<aside class="notes">
							How can we develop automation the right way?
							And how can we leverage Chef to have peace-of-mind?
						</aside>
					</section>
					<section>
						<img src="images/chef-overview-1.png" style="height: 400px; margin-top:150px;">
						<aside class="notes">
							Some background, let's see how simplified Chef infrastructure looks like
						</aside>
					</section>
					<section>
						<img src="images/chef-overview-2.png" style="height: 500px; margin-top:150px;">
						<aside class="notes">
							Let's add a bit of complexity
						</aside>
					</section>
					<section>
						<a href="https://docs.chef.io/chef_overview.html" target="_blank">
							<img src="images/chef-overview-3.png" style="height: 600px; margin-top:100px;">
						</a>
						<aside class="notes">
							...and here it is, the whole Chef ecosystem!
						</aside>
					</section>
				</section>

				<section>
					<!-- <h1>Focus on this</h1> -->
					<section data-background="images/chef-overview-3-crop.png" data-background-size="600px">
						<!-- <img src="images/chef-overview-3-crop.png" style="height: 400px; margin-top:150px;"> -->
						<aside class="notes">
							For the purpose of this presentation we focus on this section only.
							We will see how to use the various tools of the Chef Ecosystem,
						</aside>
					</section>
				</section>

				<section>
					<!-- <h2>Cooking with Chef</h2> -->
					<img src="images/code-and-test.png" style="height: 400px; margin-top:0px; border:0px;" />
				</section>

				<section id="coding-2-fragments">
					<h2>In short</h2>
					<p>
						<span class="fragment">code</span><br />
						<span class="fragment">test it</span><br />
						<span class="fragment"><i>OK?</i></span>
						<span class="fragment">push it</span><br />
						<span class="fragment"><i>KO?</i></span>
						<span class="fragment">fix it!</span><br />
					</p>
				</section>

				<section>
					<h1 style="font-size:300px">?</h1>
					<aside class="notes">
						Question is "how"?
					</aside>
				</section>

				<section>
					<!-- <h1>Install Chef DK</h1> -->
					<section>
						<a href="https://downloads.chef.io/chef-dk/" target="_blank">
							<img src="images/chef-dk.png" style="height: 400px; margin-top:0px; border:0px;" />
						</a>
						<aside class="notes">
							First thing first: install <b>Chef DK</b><br>
							It is a package which provides developers with all the tools to start developing and testing cookbooks.
						</aside>
					</section>
					<section>
						<a href="http://berkshelf.com/" target="_blank">Berkshelf</a><br>
						<a href="http://kitchen.ci/" target="_blank">Test Kitchen</a><br>
						<a href="http://acrmp.github.io/foodcritic/" target="_blank">Foodcritic</a><br>
						and many others
						<aside class="notes">
							- Berkshelf, dependency manager, i.e. "for cookbook A to work, cookbook B has to be installed"<br>
							- Test Kitchen, integration testing framework<br>
							- Foodcritic, linting tool for doing static code analysis on cookbooks<br>
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
							That might save you from headaches ([Chef Docs](https://docs.chef.io/install_dk.html)):
```
$ which ruby
/opt/chefdk/embedded/bin/ruby
```
						</script>
						<aside class="notes">
							Use ruby provided by Chef DK
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
							and that too:
```
$ chef shell-init bash
export PATH="/opt/chefdk/bin:/Users/siso/.chefdk/gem/ruby/2.1.0/bin:/opt/chefdk/embedded/bin:/opt/chefdk/bin:/Users/siso/.chefdk/gem/ruby/2.1.0/bin:/opt/chefdk/embedded/bin:/usr/local/bin:/usr/local/sbin:/usr/local/share/python:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
export GEM_ROOT="/opt/chefdk/embedded/lib/ruby/gems/2.1.0"
export GEM_HOME="/Users/siso/.chefdk/gem/ruby/2.1.0"
export GEM_PATH="/Users/siso/.chefdk/gem/ruby/2.1.0:/opt/chefdk/embedded/lib/ruby/gems/2.1.0"
```
						</script>
						<aside class="notes">
							Add that to "~/.bashrc", "~/.bash_profile" or whatever your shell uses
						</aside>
					</section>
				</section>

				<section>
					<h2>Project Specs</h2>
					<section id="project-specs-fragments">
						<h3 class="fragment">Goal</h3>
						<p class="fragment">Deploy this Node.js presentation</p>
						<h3 class="fragment">Tasks</h3>
						<p class="fragment">Node.js should be installed</p>
						<p class="fragment">Checkout Git repository</p>
						<p class="fragment">Let the Internet access the web-server</p>
						<p class="fragment">Web-server should not run as root</p>
					</section>
					<aside class="notes">
						What do we want to achieve?

						- The aim of the game is to deploy this Node.js presentation on a node.

						How?

						- Node.js should be installed in order to serve content.
						- Checkout git-repository (did I say this is slide-deck is pure code? ;)
						- Web server should be accessible on the Web
						- Web server should not run as root
					</aside>
				</section>

				<section>
					<!-- <h2>Chef Supermarket</h2> -->
					<section>
						<img src="images/board-114656_640.jpg" style="height: 600px; margin-top:75px; border:0px;" />
						<aside class="notes">
							Start from scratch?<br>
							Re-invent the wheel?<br>
						</aside>
					</section>
					<section>
						<a href="https://supermarket.chef.io/" target="_blank">
							<img src="images/chef-supermarket.png" style="height: 600px; margin-top:75px; border:0px;" />
						</a>
						<aside class="notes">
							Do not re-invent the wheel, see what's already available, by and for the community.
						</aside>
					</section>
					<section>
						<a href="https://supermarket.chef.io/" target="_blank">
							<img src="images/supermarket-nodejs.png" style="height: 600px; margin-top:75px; border:0px;" />
						</a>
					</section>
					<section>
						<a href="https://supermarket.chef.io/" target="_blank">
							<img src="images/supermarket-rackspace_iptables.png" style="height: 600px; margin-top:75px; border:0px;" />
						</a>
					</section>
				</section>

				<section>
					<h2>Let's cook</h2>
					<section data-background="images/lets_cook_mr_white.png" data-background-size="250px">
						&nbsp;
					</section>
					<section data-markdown>
						<script type="text/template">
							**Manually**

							```shell
							$ cd cookbooks
							$ mkdir -p foo/attributes foo/recipes
							$ cat > foo/metadata.rb << EOF
							> name             'foo'
							> maintainer       'YOUR_COMPANY_NAME'
							> maintainer_email 'YOUR_EMAIL'
							> license          'All rights reserved'
							> description      'Installs/Configures foo'
							> long_description IO.read(File.join(File.dirname(__FILE__), 'README.md'))
							> version          '0.1.0'
							> EOF
							```
						</script>
						<aside class="notes">
							It's a manual task, then it's prone to errors
						</aside>
					</section>
					<section>
						<i>...are you kidding me?!</i>
					</section>
					<section data-markdown>
						<script type="text/template">
							**knife**
							```shell
							$ knife cookbook create foo
							** Creating cookbook foo in /Users/siso/.chef/cookbooks
							** Creating README for cookbook: foo
							** Creating CHANGELOG for cookbook: foo
							** Creating metadata for cookbook: foo

							$ ls /Users/siso/.chef/cookbooks/foo/
							CHANGELOG.md README.md    attributes   definitions  files
							libraries    metadata.rb  providers    recipes      resources
							templates
							```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							**Berkshelf**
							```
							$ berks cookbook cheftdd
							```
							*Get off on the right foot!*
						</script>
						<aside class="notes">
							What is Berkshelf?<br>

							Let me give you an example:<br>

							Berkshelf is to Chef, what APT is to Debian, or Yum to RedHat<br>

							It's a package manager, and dependency resolver
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
							**Berkshelf**
							```
$ berks cookbook cheftdd
create  cheftdd/files/default
create  cheftdd/templates/default
create  cheftdd/attributes
create  cheftdd/libraries
create  cheftdd/providers
create  cheftdd/recipes
create  cheftdd/resources
create  cheftdd/recipes/default.rb
create  cheftdd/metadata.rb
create  cheftdd/LICENSE
create  cheftdd/README.md
create  cheftdd/CHANGELOG.md
create  cheftdd/Berksfile
create  cheftdd/Thorfile
create  cheftdd/chefignore
create  cheftdd/.gitignore
create  cheftdd/Gemfile
create  .kitchen.yml
append  Thorfile
create  test/integration/default
append  .gitignore
append  .gitignore
append  Gemfile
append  Gemfile
You must run `bundle install' to fetch any new gems.
create  cheftdd/Vagrantfile
							```
						</script>
						<aside class="notes">
							The skeleton of new cookbook is available<br>

							Also, it templates files for KitchenCI, Vagrant, and testing<br>
							so that it is possible to start developing cookbooks proficiently<br>
							right away.
						</aside>
					</section>
				</section>

				<section>
					<h2>Grab Ruby Gems</h2>
					<section data-background="images/ruby-gem.png" data-background-size="250px">
						&nbsp;
					</section>
					<section data-markdown>
						<script type="text/template">
							**[Bundler](http://bundler.io/)**
							```
$ bundle
Fetching gem metadata from https://rubygems.org/.......
Fetching additional metadata from https://rubygems.org/..
Resolving dependencies...
Using rake 10.4.2
Installing CFPropertyList 2.3.1
...
Using vagrant-wrapper 2.0.2
Your bundle is complete!
Use `bundle show [gemname]` to see where a bundled gem is installed.
							```
						</script>
						<aside class="notes">
							Resolve Ruby dependencies with bundles
							Have Ruby Gems installed
						</aside>
					</section>
				</section>

				<section>
					<h2>Rubocop</h2>
					<section>
						<a href="http://batsov.com/rubocop/" target="_blank">
							<img src="images/rubo-logo-horizontal.png" style="margin-top:100px; border:0px;" />
						</a><br>
						A Ruby static code analyzer, based on the community Ruby style guide.
					</section>
					<section data-markdown>
						<script type="text/template">
```
$ rubocop
warning: parser/current is loading parser/ruby21, which recognizes
warning: 2.1.5-compliant syntax, but you are running 2.1.4.
Inspecting 2 files
..

2 files inspected, no offenses detected
```

All good!
						</script>
						<aside class="notes">
							Analyse Ruby code with Rubocop, make recipies have similar style, and syntax too!
						</aside>
					</section>
				</section>

				<section>
					<h2>Foodcritic</h2>
					<a href="http://acrmp.github.io/foodcritic/" target="_blank">Foodcritic</a> is a lint tool for your Opscode Chef cookbooks.
					<aside class="notes">
						perform static analysis of source code
					</aside>
				</section>

				<section>
					<h2>Rake</h2>
					<a href="http://rake.rubyforge.org/" target="_blank">Rake</a> is a simple ruby build program with capabilities similar to make.
				</section>

				<section>
					<h2>Check style</h2>
					<section id="check-style-fragments">
						<p class="fragment">Use <a href="http://rake.rubyforge.org/" target="_blank">Rake</a></p>
						<p class="fragment">to run <a href="http://batsov.com/rubocop/" target="_blank">Rubocop</a> and <a href="http://acrmp.github.io/foodcritic/" target="_blank">Foodcritic</a></p>
						<p class="fragment">in the right environment</p>
						<p class="fragment">with <a href="http://bundler.io/" target="_blank">Bundler</a></p>
						<aside class="notes">
							run and check that bundle rake exec style is happy
						</aside>
					</section>

					<section data-markdown>
						<script type="text/template">
```
$ bundle exec rake style
RACK005: Cookbook metadata must have maintainer='Rackspace' maintainer_email='rackspace-cookbooks@rackspace.com': /Users/siso/workspaces/chef/cookbooks/cheftdd/metadata.rb:2
RACK005: Cookbook metadata must have maintainer='Rackspace' maintainer_email='rackspace-cookbooks@rackspace.com': /Users/siso/workspaces/chef/cookbooks/cheftdd/metadata.rb:3
RACK008: Files expected by Support must exist: Berksfile.lock:0
RACK009: Berksfile.lock must not be in .gitignore: .gitignore:11
warning: parser/current is loading parser/ruby21, which recognizes
warning: 2.1.5-compliant syntax, but you are running 2.1.4.
Running RuboCop...
Inspecting 2 files
..

2 files inspected, no offenses detected
```

*Need to fix something*
						</script>
						<aside class="notes">
TODO -- COPIED WRONG OUTPUT "no offenses"!!

							Address quickly common issues that might have when trying to converge
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
Change *Maintainer* and *email*, and try again:
```
$ bundle exec rake style
RACK008: Files expected by Support must exist: Berksfile.lock:0
RACK009: Berksfile.lock must not be in .gitignore: .gitignore:11
warning: parser/current is loading parser/ruby21, which recognizes
warning: 2.1.5-compliant syntax, but you are running 2.1.4.
Running RuboCop...
Inspecting 2 files
..

2 files inspected, no offenses detected
```

*It's better*
						</script>
						<aside class="notes">
							Address quickly common issues that might have when trying to converge
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
Generate `Berkshelf.lock`:

```
$ berks install
Resolving cookbook dependencies...
Fetching 'cheftdd' from source at .
Fetching cookbook index from https://supermarket.chef.io...
Using cheftdd (0.1.0) from source at .
```

and let Git handle it
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
Try again:
```
$ bundle exec rake style
warning: parser/current is loading parser/ruby21, which recognizes
warning: 2.1.5-compliant syntax, but you are running 2.1.4.
Running RuboCop...
Inspecting 2 files
..

2 files inspected, no offenses detected
```

OK!
						</script>
					</section>
				</section>

				<section>
					<!-- <h2>Unit Testing</h2> -->
					<section>
						<img src="images/love-the-unit-test.jpg" style="height: 500px; margin-top:100px; border:0px;" />
					</section>
					<aside class="notes">
						What is it about?<br>
						Why?<br>
						How?<br>
						<br>
						<br>
						We have Project Specs<br>
						<br>
						With Unit Tests we know that we performed all actions required from Project Specs<br>
						We have to write tests to be sure that we tick all the boxes, from Project Specs.
					</aside>
				</section>

				<section>
					<!-- <h2>TDD, and BDD</h2> -->
					<section id="tdd-bdd-serverspec-fragments">
						<a href="http://serverspec.org/" target="_blank">
							<img src="images/serverspec.png" style="margin-top:100px; border:0px;">
						</a>
						<br>
						<p class="fragment">
							 write RSpec tests
						</p>
						<p class="fragment">
							 check servers are configured correctly
						</p>
					</section>
					<section id="tdd-bdd-rspec-fragments">
						<a href="http://rspec.info/" target="_blank">
							<img src="images/rspec.png" style="margin-top:100px; border:0px;">
						</a>
						<p>
							<a href="http://rspec.info/" target="_blank">
								RSpec
							</a>
						</p>
						<p class="fragment">
							Behaviour Driven Development for Ruby
						</p>
						<p class="fragment">
							Making TDD Productive and Fun
						</p>
					</section>
					<section>
						Default recipe should<br><br>
						<ul>
							<li>update the package-manager database</li>
							<li>upgrade packages</li>
						</ul>
					</section>
					<section data-markdown>
						<script type="text/template">
							Which is
							```
# apt-get update
# apt-get upgrade
							```
						</script>
					<aside class="notes">
						...
					</aside>
				</section>
				<section data-markdown>
					<script type="text/template">
						Then write a test
```
$ cat test/unit/spec/default_spec.rb

...

it 'executes apt-get update' do
  expect(chef_run).to run_execute('apt-get update')
end

...

```
					</script>
					<aside class="notes">
						...
					</aside>
				</section>
				<section data-markdown>
					<script type="text/template">
						it fails
```
$ bundle exec rake spec
/opt/chefdk/embedded/bin/ruby -I/Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-core-3.2.2/lib:/Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-support-3.2.2/lib /Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-core-3.2.2/exe/rspec --pattern spec/\*\*\{,/\*/\*\*\}/\*_spec.rb test/unit
F

Failures:

  1) cheftdd::default executes apt-get update
     Failure/Error: expect(chef_run).to run_execute('apt-get update')
       expected "execute[apt-get update]" with action :run to be in Chef run. Other execute resources:



     # ./test/unit/spec/default_spec.rb:23:in `block (2 levels) in <top (required)>'

Finished in 0.15203 seconds (files took 2.39 seconds to load)
1 example, 1 failure

Failed examples:

rspec ./test/unit/spec/default_spec.rb:22 # cheftdd::default executes apt-get update


  No Chef resources found, skipping coverage calculation...
/opt/chefdk/embedded/bin/ruby -I/Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-core-3.2.2/lib:/Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-support-3.2.2/lib /Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-core-3.2.2/exe/rspec --pattern spec/\*\*\{,/\*/\*\*\}/\*_spec.rb test/unit failed
```
					</script>
					<aside class="notes">
						...
					</aside>
				</section>
				<section data-markdown>
					<script type="text/template">
Write code to pass the test
```
#
# Cookbook Name:: cheftdd
# Recipe:: default
#
# Copyright (C) 2015 YOUR_NAME
#
# All rights reserved - Do Not Redistribute
#

execute "apt-get update/upgrade" do
  command "apt-get update"
  action :run
end
```
					</script>
					<aside class="notes">
						...
					</aside>
				</section>
				<section data-markdown>
					<script type="text/template">
						Run the test again
```
$ bundle exec rake spec
/opt/chefdk/embedded/bin/ruby -I/Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-core-3.2.2/lib:/Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-support-3.2.2/lib /Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-core-3.2.2/exe/rspec --pattern spec/\*\*\{,/\*/\*\*\}/\*_spec.rb test/unit
.

Finished in 0.16453 seconds (files took 2.52 seconds to load)
1 example, 0 failures


ChefSpec Coverage report generated...

  Total Resources:   1
  Touched Resources: 1
  Touch Coverage:    100.0%

You are awesome and so is your test coverage! Have a fantastic day!
```
*it's OK!*
					</script>
					<aside class="notes">
						...
					</aside>
				</section>
			</section>

			<section data-background="images/meme-keep_on_going.jpg" data-background-size="600px">
				<aside class="notes">
					...
				</aside>
			</section>

				<section>
					<h2>'nodejs' recipe</h2>
					<section id="install-nodejs-deploy-webapp-fragments">
						<p class="fragment">
							Install Node.js<br>
						</p>
						<p class="fragment">
							+<br>
							deploy web-app
						</p>
						<aside class="notes">
							- Server is now updated, Node.js can be installed<br>
							- Need to install Node.js, install packages with npm, grunt and all that jazz<br>
						</aside>
					</section>
					<section>
						<a href="https://supermarket.chef.io/" target="_blank">
							<img src="images/supermarket-nodejs.png" style="height: 600px; margin-top:75px; border:0px;" />
						</a>
						<aside class="notes">
							- 'nodejs' recipe is available on Chef Supermarket<br>
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">

Deploy [reveal.js](https://github.com/hakimel/reveal.js#installation):

- install [Node.js](http://nodejs.org/) and [Grunt](http://gruntjs.com/getting-started#installing-the-cli)
- clone reveal.js
   ```sh
   $ git clone https://github.com/hakimel/reveal.js.git
   ```
- resolve dependencies
   ```sh
   $ npm install
   ```

- serve the slide-deck
   ```sh
   $ grunt serve --port 80
   ```
						</script>
						<aside class="notes">
							...
						</aside>
					</section>
					<section id="rspec-filenaming-schema-fragments">
						<h4>File-naming schema</h4>
						<p class="fragment" style="font-family:'Courier New'">
							recipes/nodejs.rb
						</p>
						<p class="fragment" style="font-family:'Courier New'">
							&#x21D3;<br>
							test/unit/spec/nodejs_spec.rb
						</p>
					</section>
					<section data-markdown>
						<script type="text/template">
`test/unit/spec/nodejs_spec.rb`
```
it 'include nodejs recipe' do
  expect(chef_run).to include_recipe('nodejs')
end

# Follow instructions to install reveal.js on https://github.com/hakimel/reveal.js/
it 'install grunt-cli' do
  expect(chef_run).to run_execute('npm install -g grunt-cli')
end

it 'install git' do
  expect(chef_run).to install_apt_package('git')
end

it 'clone reveal.js GitHub repository' do
  expect(chef_run).to run_execute('git clone https://github.com/hakimel/reveal.js.git')
end

it 'install npm packages' do
  expect(chef_run).to run_execute('npm install')
end
```
						</script>
						<aside class="notes">
							Write test for nodejs recipe
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
`recipes/nodejs.rb` tests fail:
```
$ bundle exec rake spec
/opt/chefdk/embedded/bin/ruby -I/Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-core-3.2.2/lib:/Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-support-3.2.2/lib /Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-core-3.2.2/exe/rspec --pattern spec/\*\*\{,/\*/\*\*\}/\*_spec.rb test/unit
.FFFFF

Failures:

  1) cheftdd::nodejs include nodejs recipe
     Failure/Error: expect(chef_run).to include_recipe('nodejs')
       expected ["cheftdd::nodejs"] to include "nodejs::default"
     # ./test/unit/spec/nodejs_spec.rb:23:in `block (2 levels) in <top (required)>'

  2) cheftdd::nodejs install grunt-cli
     Failure/Error: expect(chef_run).to run_execute('npm install -g grunt-cli')
       expected "execute[npm install -g grunt-cli]" with action :run to be in Chef run. Other execute resources:



     # ./test/unit/spec/nodejs_spec.rb:28:in `block (2 levels) in <top (required)>'

  3) cheftdd::nodejs install git
     Failure/Error: expect(chef_run).to install_apt_package('git')
       expected "apt_package[git]" with action :install to be in Chef run. Other apt_package resources:



     # ./test/unit/spec/nodejs_spec.rb:32:in `block (2 levels) in <top (required)>'

  4) cheftdd::nodejs clone reveal.js GitHub repository
     Failure/Error: expect(chef_run).to run_execute('git clone https://github.com/hakimel/reveal.js.git')
       expected "execute[git clone https://github.com/hakimel/reveal.js.git]" with action :run to be in Chef run. Other execute resources:



     # ./test/unit/spec/nodejs_spec.rb:36:in `block (2 levels) in <top (required)>'

  5) cheftdd::nodejs install npm packages
     Failure/Error: expect(chef_run).to run_execute('npm install')
       expected "execute[npm install]" with action :run to be in Chef run. Other execute resources:



     # ./test/unit/spec/nodejs_spec.rb:40:in `block (2 levels) in <top (required)>'

Finished in 1.03 seconds (files took 2.45 seconds to load)
6 examples, 5 failures

Failed examples:

rspec ./test/unit/spec/nodejs_spec.rb:22 # cheftdd::nodejs include nodejs recipe
rspec ./test/unit/spec/nodejs_spec.rb:27 # cheftdd::nodejs install grunt-cli
rspec ./test/unit/spec/nodejs_spec.rb:31 # cheftdd::nodejs install git
rspec ./test/unit/spec/nodejs_spec.rb:35 # cheftdd::nodejs clone reveal.js GitHub repository
rspec ./test/unit/spec/nodejs_spec.rb:39 # cheftdd::nodejs install npm packages
```
						</script>
						<aside class="notes">
							See tests for `recipes/nodejs.rb` recipe fail
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
Install [Node.js](https://nodejs.org/)
```
#
# Cookbook Name:: cheftdd-demo
# Recipe:: nodejs
#
# Copyright (C) 2015 YOUR_NAME
#
# All rights reserved - Do Not Redistribute
#

#
# Install reveal.js - https://github.com/hakimel/reveal.js/
#

# install nodejs, from package by default
include_recipe 'nodejs'

execute 'install grunt-cli' do
  command 'npm install -g grunt-cli'
  action :run
end
```
						</script>
						<aside class="notes">
							pending
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
Install [reveal.js](https://github.com/hakimel/reveal.js)
```
package 'git' do
  action :install
end

execute 'clone reveal.js GitHub repository' do
  command 'git clone https://github.com/hakimel/reveal.js.git'
  action :run
  cwd '/opt'
  not_if { File.exist?('/opt/reveal.js') }
end
```
						</script>
						<aside class="notes">
							pending
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
Resolve dependencies
```
execute 'install npm packages' do
  command 'npm install'
  action :run
  cwd '/opt/reveal.js'
end

execute 'start serving node.js app' do
  command 'grunt serve &'
  action :run
  cwd '/opt/reveal.js'
end
```
						</script>
						<aside class="notes">
							pending
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
Test `nodejs` recipe:
```
$ bundle exec rake spec
/opt/chefdk/embedded/bin/ruby -I/Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-core-3.2.2/lib:/Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-support-3.2.2/lib /Users/siso/.chefdk/gem/ruby/2.1.0/gems/rspec-core-3.2.2/exe/rspec --pattern spec/\*\*\{,/\*/\*\*\}/\*_spec.rb test/unit
......

Finished in 1.06 seconds (files took 2.51 seconds to load)
6 examples, 0 failures
```
*Great, it's OK!*
						</script>
						<aside class="notes">
							pending
						</aside>
					</section>
				</section>

				<section>
					<h2>Integration Testing</h2>
					<section>
						<img src="images/experiment-meme.jpg" style="height: 500px; margin-top:100px; border:0px;" />
					</section>
					<aside class="notes">
						What is it about?<br>
						Why?<br>
						How?<br>
						<br>
						<br>
						With Unit Tests we know that we performed all actions required from Project Specs<br>
						With Integration Tests we test that systems run as expected.<br>
					</aside>
				</section>

				<section>
					<h2>Test Kitchen</h2>
					<section>
						<a href="http://kitchen.ci/" target="_blank">
							<img src="images/test-kitchen-homepage.png" style="border:0px; height: 600px; margin-top:100px;">
						</a>
					</section>
					<section id="testkitchen-fragments">
						<span>
							- run Integration Tests<br>
						</span>
						<span class="fragment">
							- awesome <a href="http://kitchen.ci/docs/getting-started/" target="_blank">documentation</a><br>
						</span>
						<span class="fragment">
							<i>have a read!</i>
						</span>
					</section>
					<aside class="notes">
						- Integration testing
						- Run Integration Tests with Test-Kitchen, bats, and all that jazz
						- Use Chef Zero, In-memory Chef Server, it's super-fast and light-weight
					</aside>
				</section>

				<section>
					<h2>.kitchen.yml</h2>
					<section data-markdown>
						<script type="text/template">
```
---
driver:
  name: vagrant
  customize:
    memory: 1024
```
						</script>
						<aside class="notes">
							pending
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
```
provisioner:
  name: chef_zero
  nodes_path: "test/integration/nodes"
  require_chef_omnibus: 11.16.4
  client_rb:
    environment: _default
  attributes:
    testkitchen: true
    openssh:
      server:
        password_authentication: 'yes'
        permit_root_login: 'yes'
    authorization:
      sudo:
        users: ['vagrant']
        passwordless: true
```
						</script>
						<aside class="notes">
							...
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
```
platforms:
  - name: ubuntu-14.04
```
						</script>
						<aside class="notes">
							platforms to run tests on
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
```
suites:
  - name: default
    run_list:
      attributes:

  - name: nodejs
    run_list:
      - recipe[cheftdd::default]
      - recipe[cheftdd::nodejs]
```
						</script>
						<aside class="notes">
							...
						</aside>
					</section>
				</section>

				<section>
					<h2><!-- KitchenCI -  -->Node lifecycle</h2>
					<section data-markdown>
						<script type="text/template">
Current status of nodes:
```
$ kitchen list
Instance            Driver     Provisioner  Last Action
nodejs-ubuntu-1404  Rackspace  ChefZero     Not Created
```
						</script>
						<aside class="notes">
							...
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
Create node
```
# kitchen create
```
						</script>
						<aside class="notes">
							...
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
Node status
```
$ kitchen list
Instance            Driver     Provisioner  Last Action
nodejs-ubuntu-1404  Rackspace  ChefZero     Created
```
						</script>
						<aside class="notes">
							It's just a vanilla server
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
Converge node
```
# kitchen converge
```
						</script>
						<aside class="notes">
							...
						</aside>
					</section>
					<section id="kitchen-converge-fragments">
						<h4>converge node</h4>
						<p class="fragment">
							run <font style="">chef-client</font> on node
						</p>
						<p class="fragment">
							apply recipes
						</p>
					</section>
					<section data-markdown>
						<script type="text/template">
Node status
```
$ kitchen list
Instance            Driver     Provisioner  Last Action
nodejs-ubuntu-1404  Rackspace  ChefZero     Converged
```
						</script>
						<aside class="notes">
							...
						</aside>
					</section>
				</section>

				<section>
					<h2>Integration Tests</h2>
					<section id="write-integration-tests-fragments">
						<h4 class="fragment">File-naming schema</h4>
						<p class="fragment" style="font-family:'Courier New'">
							test/integration/SUITE/rspec/WHATEVER_spec.rb
						</p>
						<p class="fragment">
							&#x21D3;
						</p>
						<p class="fragment" style="font-family:'Courier New'">
							KitchenCI SUITE: nodejs
						</p>
						<p class="fragment" style="font-family:'Courier New'">
							&#x21D3;<br>
							test/integration/nodejs/rspec/nodejs_spec.rb
						</p>
					</section>
					<section id="write-integration-tests-0">
						<h4 class="fragment">Recipe</h4>
						<pre class="fragment">
# install nodejs, from package by default
include_recipe 'nodejs'
						</pre>
						<h4 class="fragment">Test</h4>
						<pre class="fragment">
describe command('nodejs --version') do
  its(:stdout) { should match(/v0.10.37/) }
end
						</pre>
					</section>
					<section id="write-integration-tests-0">
						<h4 class="fragment">Recipe</h4>
						<pre class="fragment">
package 'git' do
  action :install
end
						</pre>
						<h4 class="fragment">Test</h4>
						<pre class="fragment">
describe package('git') do
  it { should be_installed }
end
						</pre>
					</section>
					<section id="write-integration-tests-0">
						<h4 class="fragment">Recipe</h4>
						<pre class="fragment">
execute 'clone reveal.js GitHub repository' do
  command 'git clone https://github.com/hakimel/reveal.js.git'
  action :run
  cwd '/opt'
  not_if { File.exist?('/opt/reveal.js') }
end
						</pre>
						<h4 class="fragment">Test</h4>
						<pre class="fragment">
describe file('/opt/reveal.js') do
  it { should be_directory }
end
						</pre>
					</section>
					<section id="write-integration-tests-0">
						<h4 class="fragment">Recipe</h4>
						<pre class="fragment">
execute 'start serving node.js app' do
  command 'grunt serve --port 80 &'
  action :run
  cwd '/opt/reveal.js'
end
						</pre>
						<h4 class="fragment">Test</h4>
						<pre class="fragment">
describe port('80') do
  it { should be_listening }
end
						</pre>
					</section>
					<section id="write-integration-tests-0">
						<h4 class="fragment">Recipe</h4>
						<pre class="fragment">
add_iptables_rule('INPUT', '-p tcp -m state --state NEW --dport 80 -s 0.0.0.0/0 -j ACCEPT', 50, 'Allow the Internet access the web-server')
						</pre>
						<h4 class="fragment">Test</h4>
						<pre class="fragment">
describe iptables do
  it { should have_rule('-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -m comment --comment "Allow the Internet access the web-server" -j ACCEPT').with_chain('INPUT') }
end
						</pre>
					</section>
				</section>

				<section>
					<h2>KitchenCI - Integration Tests</h2>
					<section data-markdown>
						<script type="text/template">
Eventually, run integration tests
```
# kitchen verify
```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
```
$ kitchen verify
-----> Starting Kitchen (v1.3.1)
-----> Setting up <nodejs-ubuntu-1404>...
-----> Setting up Busser
...
-----> Verifying <nodejs-ubuntu-1404>...
...
-----> Running rspec test suite
...
       Finished in 0.09244 seconds
       4 examples, 0 failures
       Finished verifying <nodejs-ubuntu-1404> (0m2.94s).
-----> Kitchen is finished. (0m11.06s)
```
						</script>
					</section>
					<section data-background="#ffffff">
						<img src="images/meme-like_a_boss.jpg" style="height: 500px; margin-top:100px; border:0px;" /><br>
					</section>
					<section data-markdown>
						<script type="text/template">
Full output:
```
$ kitchen verify
-----> Starting Kitchen (v1.3.1)
-----> Setting up <nodejs-ubuntu-1404>...
-----> Setting up Busser
       Creating BUSSER_ROOT in /tmp/busser
       Creating busser binstub
       Plugin rspec already installed
       Finished setting up <nodejs-ubuntu-1404> (0m3.09s).
-----> Verifying <nodejs-ubuntu-1404>...
       Removing /tmp/busser/suites/rspec
       Uploading /tmp/busser/suites/rspec/Gemfile (mode=0644)
       Uploading /tmp/busser/suites/rspec/nodejs_spec.rb (mode=0644)
       Uploading /tmp/busser/suites/rspec/spec_helper.rb (mode=0644)
-----> Running rspec test suite
                run  PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/tmp/busser/gems/bin; bundle install --local || bundle install from "."
       Don't run Bundler as root. Bundler can ask for sudo if it is needed, and
       installing your bundle as root will break this application for all non-root
       users on this machine.
       Resolving dependencies...
       Using diff-lcs 1.2.5
       Using highline 1.7.1
       Using net-ssh 2.9.2
       Using rspec-core 2.99.2
       Using rspec-expectations 2.99.2
       Using rspec-mocks 2.99.3
       Using rspec 2.99.0
       Using rspec-its 1.0.1
       Using specinfra 1.27.5
       Using serverspec 1.16.0
       Using bundler 1.9.1
       Bundle complete! 1 Gemfile dependency, 11 gems now installed.
       Use `bundle show [gemname]` to see where a bundled gem is installed.
       ....

       Finished in 0.09244 seconds
       4 examples, 0 failures
       Finished verifying <nodejs-ubuntu-1404> (0m2.94s).
-----> Kitchen is finished. (0m11.06s)
```
						</script>
					</section>
				</section>

				<section>
					<section>
						<h2>All in one go</h2>
						<p class="fragment" style="font-family:'Courier New'">
							$ kitchen test
						</p>
						<p class="fragment" style="font-family:'Courier New'">
							<font style="color:#555">«ha ah»</font>
						</p>
					</section>
					<section id="test-kitchen-just-test-fragments">
						<p class="fragment" style="font-family:'Courier New'">
							<b>$ kitchen test</b>
						</p>
						<p class="fragment" style="font-family:'Courier New'">
							&#x21D3;<br>
							$ kitchen destroy
						</p>
						<p class="fragment" style="font-family:'Courier New'">
							&#x21D3;<br>
							$ kitchen create
						</p>
						<p class="fragment" style="font-family:'Courier New'">
							&#x21D3;<br>
							$ kitchen converge
						</p>
						<p class="fragment" style="font-family:'Courier New'">
							&#x21D3;<br>
							$ kitchen verify
						</p>
						<p class="fragment" style="font-family:'Courier New'">
							&#x21D3;<br>
							$ kitchen destroy
						</p>
					</section>
				</section>

				<section>
					<h2>Links</h2>
					<span style="text-align: left;">
						<small>
							- <i>click links on this slide-deck</i><br>
							- <a href="https://docs.chef.io/chef_overview.html" target="_blank">An Overview of Chef</a><br>
							- <a href="https://downloads.chef.io/chef-dk/" target="_blank">Install Chef DK</a><br>
							- <a href="https://speakerdeck.com/nathenharvey/tdd-with-chef" target="_blank">TDD with Chef, by Nathen Harvey</a><br>
							- <a href="https://github.com/hakimel/reveal.js" target="_blank">reveal.js</a><br>
						</small>
					</span>
				</section>

				<section>
					<!-- <h1>DevOps jokes</h1> -->
					<section>
						<img src="images/automate-all-the-things_360.png" style="height: 500px; margin-top:100px; border:0px;" />
					</section>
					<section>
						<img src="images/tests-eveywhere.jpg" style="height: 400px; margin-top:100px; border:0px;" />
					</section>
					<section>
						<img src="images/I-know-TDD.jpg" style="height: 500px; margin-top:100px; border:0px;" />
					</section>
					<section>
						<img src="images/meme-bugs-1.jpg" style="height: 500px; margin-top:100px; border:0px;" />
					</section>
					<section>
						<img src="images/devopsreactions.gif" style="height: 500px; margin-top:100px; border:0px;" /><br>
						When you think you have it under control -- <a href="http://devopsreactions.tumblr.com/" target="_blank">devopsreactions</a>
					</section>
					<aside class="notes">
						DevOps presentation is not finished unless you see memes!
					</aside>
				</section>

				<section>
					<aside class="notes">
						How many quotes did you spot?
					</aside>
					<table>
						<thead>
							<tr>
								<th>Source</th>
								<th>Quantity</th>
							</tr>
						</thead>

							<tbody>
								<tr>
									<td>The Big Bang Theory</td>
									<td>1</td>
								</tr>
								<tr>
									<td>Breaking Bad</td>
									<td>1</td>
								</tr>
								<tr>
									<td>How I Met Your Mother</td>
									<td>2</td>
								</tr>
								<tr>
									<td>Matrix</td>
									<td>1</td>
								</tr>
							</tbody>
					</table>
				</section>

			</div>

			<!-- **************************************** Slide-deck -->

		</div>

		<script src="../lib/js/head.min.js"></script>
		<script src="../js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: '../lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: '../plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: '../plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: '../plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: '../plugin/zoom-js/zoom.js', async: true },
					{ src: '../plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
